version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - npx npm install
        build:
          commands:
            - echo "NEXT_PUBLIC_AWS_BRANCH=$AWS_BRANCH" > .env
            - echo "NEXT_PUBLIC_AWS_APP_ID=$AWS_APP_ID" >> .env
            - cat .env
            - npx turbo run build --filter=dex
        postBuild:
          commands:
            # this copies the files back to the root of the "standalone" folder so Amplify can find them
            # keep an eye on https://github.com/aws-amplify/amplify-hosting/issues/3179
            # for possible long-term fix from the Amplify team
            - cp -r .next/standalone/apps/dex/. .next/standalone
      artifacts:
        baseDirectory: .next
        files:
          - "**/*"
      cache:
        paths:
          - node_modules/**/*
    appRoot: apps/dex
